# Folio — Investment Analysis System

**Folio** is a self-hosted, thesis-driven stock tracking system for disciplined investors. Track watchlist stocks, monitor market signals, and analyze currency exposure.

## Quick Start

```bash
docker compose up -d
make ci                  # Full CI check — mirrors ALL GitHub CI pipeline jobs
make test                # Run all tests (backend + frontend)
make backend-test-quick  # Fast backend tests — no coverage, for local iteration
make lint                # Lint all (backend + frontend)
make format              # Format code
make clean               # Remove build caches
```

## Dependency Management (pip-tools)

Backend dependencies use [pip-tools](https://pip-tools.readthedocs.io/) for reproducible builds:

- **`backend/requirements.in`** — direct dependencies with loose version constraints (edit this)
- **`backend/requirements.txt`** — auto-generated lock file with all transitive deps pinned (do NOT edit by hand)

```bash
make lock          # Resolve requirements.in → requirements.txt (after editing .in)
make upgrade       # Re-lock all deps to latest compatible versions
```

**Workflow:** To add or change a dependency, edit `requirements.in`, then run `make lock`. Both files are committed to git. Docker builds install from the lock file for reproducibility.

## Frontend Development

```bash
cd frontend-react && npm run dev    # Start dev server (http://localhost:3000)
cd frontend-react && npm run build  # Production build
cd frontend-react && npm run lint   # ESLint
```

## API Type Codegen

```bash
make setup          # First-time: backend install + frontend install + codegen
make generate-api   # Export OpenAPI spec + regenerate TypeScript types
```

Frontend TypeScript types in `frontend-react/src/api/types/` are derived from the backend OpenAPI spec (`openapi.json`). After changing any Pydantic schema in `backend/api/schemas/`, run `make generate-api` to keep types in sync.

- `frontend-react/src/api/openapi.json` — committed API contract; reviewable in PRs
- `frontend-react/src/api/types/generated.d.ts` — gitignored build artifact; auto-regenerated by `npm run build` and `npm run dev`

See `.cursor/rules/` for project conventions and coding standards.

## Architecture Boundaries (enforced by `backend/tests/test_architecture.py`)

Layer dependency direction: `domain/` (core, analysis, portfolio) → `application/` (stock, scan, portfolio, guru, messaging, settings) → `infrastructure/` (market_data, persistence, external) → `api/` (routes, schemas)

- **`api/routes/`** MUST delegate to `application/<domain>/` services. Only `infrastructure.database` (`get_session`, `engine`) is allowed in `api/`.
- **`domain/`** must not import from any outer layer.
- Run `make ci` after any backend change to verify boundaries. `make ci` mirrors all GitHub CI pipeline jobs — if it passes locally, the pipeline will pass too. The `CI Gate` job aggregates all pipeline results and is the sole required status check for merging to `main`.

## Test Coverage

Coverage is enforced in CI via a ratchet approach — thresholds only ever increase.

- **Backend**: `make backend-test` runs pytest with `pytest-cov`. Threshold is enforced via `--cov-fail-under=85` on the pytest command line (in `Makefile` and `.github/workflows/ci.yml`). CI fails if coverage drops below it.
- **Important**: Do NOT set `fail_under` in `[tool.coverage.report]` in `backend/pyproject.toml`. It affects all `coverage` subcommands including those run internally by third-party GitHub Actions (e.g. `py-cov-action/python-coverage-comment-action`), causing CI failure with exit code 2. Use `--cov-fail-under=N` on the pytest command line only.
- **Frontend**: `make frontend-test` runs `vitest run --coverage`. Thresholds are in `frontend-react/vitest.config.ts` under `coverage.thresholds` (lines: 4%, branches: 60%, functions: 25%). `src/components/ui/` is excluded — those are third-party shadcn wrappers.
- To raise the floor: improve coverage, confirm locally, then bump the `--cov-fail-under` value in both `Makefile` and `.github/workflows/ci.yml` and commit as the new baseline.
