---
description: Apply when working with Docker, Dockerfiles, docker-compose, docker-entrypoint.sh, or container configuration. Covers non-root execution, entrypoint patterns, and image pinning.
globs:
  - "**/Dockerfile"
  - "**/docker-compose*.yml"
  - "**/docker-entrypoint.sh"
alwaysApply: false
---

# Docker Best Practices

## Non-root Execution
- **Non-root execution:** All containers run as the `folio` user. Never run application processes as root.

## Entrypoint Pattern
- **Entrypoint pattern:** Services with persistent volumes MUST use a `docker-entrypoint.sh` script that:
  1. Runs initially as root to fix volume ownership (`chown -R folio:folio /app/data`)
  2. Drops privileges via `gosu folio` before exec'ing the main process
  3. Is idempotent (safe to run on every startup)

## Privilege Dropping
- **gosu for privilege drop:** Use `gosu` (not `su` or `sudo`) for dropping privileges in entrypoint scripts. Install via `apt-get install gosu`.

## Image Security
- **Image pinning:** Pin base images with SHA256 digest. Update periodically.
- **No USER directive with volumes:** Do not use `USER` in Dockerfiles that mount persistent volumes. Use the entrypoint pattern instead.

## React Frontend (frontend-react/)
- **Multi-stage build:** Node 20 Alpine builds the Vite app (`npm ci && npm run build`), then nginx Alpine serves the `dist/` static files.
- **No persistent volumes:** Static assets only â€” no volume mounts needed for the frontend container.
- **SPA routing:** nginx config must include `try_files $uri $uri/ /index.html` so client-side routes work on reload.
- **API proxy:** nginx proxies `/api` to `backend:8000`, enabling same-origin API calls (no CORS needed).
- **Build arg:** `VITE_API_KEY` is passed as a Docker build argument for the API key header injection.
