---
description: Core Clean Code and Clean Architecture principles for the project
alwaysApply: true
---

# Coding Standards — Clean Code + Clean Architecture

## Working with Existing Code
- Before writing new modules, check existing files in the same layer for patterns to follow.
- Reference actual files as examples (e.g., `backend/api/stock_routes.py` for route patterns, `backend/infrastructure/repositories.py` for repository patterns).
- When in doubt, match the style of the nearest existing file rather than inventing a new convention.

## Clean Architecture (Layered Structure)
- **`domain/`** — Pure business rules, entities, enums, constants. No framework imports allowed.
- **`application/`** — Use-case orchestration and service functions. Depends only on `domain/` and repository interfaces.
- **`infrastructure/`** — External adapters (yfinance, Telegram, SQLite repositories). Implements interfaces defined by upper layers.
- **`api/`** — FastAPI route handlers. Thin controllers that delegate to `application/` services.
- New code must be placed in the correct layer; never leak infrastructure concerns into `domain/`.

## Clean Code Practices
- **Small, focused functions:** Each function should do one thing well with a descriptive name.
- **No magic numbers or strings:** Use `domain/constants.py` (backend) and `frontend/config.py` (frontend) for all thresholds, TTLs, labels, and messages.
- **DRY (Don't Repeat Yourself):** Extract duplicated logic into shared helpers or modules.
- **Pure functions:** Prefer pure functions and immutable data where possible; isolate side effects at the boundary.

## General Rules
- **Type Safety:** Use Pydantic models and Python type hints everywhere.
- **Graceful Error Handling:** Never crash on external API failures (e.g., if yfinance fails, return None/Warning, don't break the app).
- **i18n (Internationalization):**
  - All user-facing strings MUST use the `t()` translation function — never hardcode Chinese text.
  - Backend: `from i18n import t`; resolve language with `lang=get_user_language(session)` at the API layer.
  - Frontend: `from i18n import t`; reads language from `st.session_state["language"]`.
  - Locale files: `backend/i18n/locales/{en,ja,zh-CN,zh-TW}.json` and `frontend/i18n/locales/{en,ja,zh-CN,zh-TW}.json`.
  - Default language: `zh-TW`. Fallback chain: requested lang → `zh-TW` → raw key string.
  - Log messages remain in Traditional Chinese (developer-facing, not translated via i18n).
- **Documentation Sync:** Any feature addition, modification, or removal MUST include updates to the corresponding documentation:
  - `README.md` — Update feature list, API reference, architecture diagrams, examples, and project structure as needed.
  - Frontend SOP manual (the `st.expander("SOP")` block in `frontend/pages/radar.py`) — Update the in-app user guide to reflect the current system behavior.
  - AI Agent Docs (`docs/agents/folio/SKILL.md` and `docs/agents/AGENTS.md`) — Update endpoint tables, webhook actions, categories, and usage tips to match API changes.
  - Never leave documentation out of date after a code change.
