---
description: Apply when working with React frontend code in the frontend-react/ directory. Covers data fetching, state management, i18n, privacy mode, and component patterns.
globs: ["frontend-react/**"]
---

# Frontend Standards (React + TypeScript)

## API Types (OpenAPI Codegen)
- Types in `src/api/types/` are barrel modules re-exporting from `./generated`. Do NOT manually define types that have a backend Pydantic `response_model`.
- `generated.d.ts` is gitignored, auto-regenerated by `npm run build`/`npm run dev`.
- Access: `import type { components } from "./generated"` → `type Foo = components["schemas"]["FooModel"]`.

## Data Fetching
- TanStack Query for all API calls. Never raw `fetch`/`axios` in components.
- `useMutation` for writes; invalidate related queries on success.
- API client: `import { apiClient } from "src/api/client"` — never import `axios` directly.
- Before writing new hooks, check existing patterns in `src/api/hooks/`.

## State Management
- **Server state:** TanStack Query. **Global UI:** Zustand (`usePrivacyMode`, `useTheme`). **Local:** `useState`.
- Avoid prop-drilling >2 levels — use Zustand.

## Constants & i18n
- All constants in `src/lib/constants.ts`. No magic strings or inline constant arrays.
- All user-facing strings: `useTranslation()` + `t("key")`. Locale files: `public/locales/{en,ja,zh-CN,zh-TW}/`.
- Key naming: dot-notation by page (e.g., `radar.add_stock`). Interpolation: `t("key", { variable })`.

## Project-Specific Hooks
- **Privacy:** `usePrivacyMode()` — Zustand store with `maskMoney()` helper. Monetary values: `privacyMode ? "***" : formatted_value`.
- **Theme:** `useTheme()` — Zustand, persisted to `localStorage` as `folio-theme`. Dark mode via `.dark` class on `<html>`.
- **Charts:** `useRechartsTheme()` for Recharts, `useLightweightChartTheme()` for TradingView charts.

## Components & Styling
- Base: shadcn/ui. Loading: `<Skeleton>`. Empty: `<EmptyState>`. Errors: `<ErrorBoundary>` via `PageShell`. Toast: `sonner`.
- Tailwind only (no inline styles). Dark: `dark:` variants. Responsive: `sm:`/`md:`/`lg:` with mobile-first grids.

## Testing (Vitest + React Testing Library)

Every new utility function, hook, and component MUST ship with tests. Run `make frontend-test` or `npm test` to verify.

### File placement and naming
- Co-locate tests in a `__tests__/` subdirectory next to the source file.
- Name: `<ModuleName>.test.ts` (pure functions/hooks) or `<ModuleName>.test.tsx` (components).
- Examples: `src/lib/__tests__/utils.test.ts`, `src/hooks/__tests__/usePrivacyMode.test.ts`, `src/components/__tests__/EmptyState.test.tsx`.

### What to test per type

| Type | What to test |
|---|---|
| Utility functions (`lib/`) | All branches of pure logic; edge cases |
| Zustand hooks (`hooks/`) | Initial state, mutations, and side effects (e.g., DOM class changes) |
| API query hooks (`api/hooks/`) | Loading state, endpoint called, response shape |
| API mutation hooks (`api/hooks/`) | Endpoint called with correct payload, success state |
| UI components (`components/`) | Renders key content, user interactions, conditional rendering |
| Constants (`lib/constants.ts`) | Entry counts, set non-overlap, key presence |

### Canonical patterns

**Component test** (`src/components/__tests__/EmptyState.test.tsx`):
```tsx
import { render, screen } from "@testing-library/react";
import userEvent from "@testing-library/user-event";
import { vi } from "vitest";

it("calls handler on click", async () => {
  const handler = vi.fn();
  render(<MyComponent onClick={handler} />);
  await userEvent.setup().click(screen.getByRole("button"));
  expect(handler).toHaveBeenCalledOnce();
});
```

**API hook test** (`src/api/hooks/__tests__/useRadar.test.ts`):
```ts
vi.mock("@/api/client", () => ({ default: { get: vi.fn(), interceptors: { request: { use: vi.fn() } } } }));

function createWrapper() {
  const qc = new QueryClient({ defaultOptions: { queries: { retry: false } } });
  return ({ children }: { children: React.ReactNode }) =>
    createElement(QueryClientProvider, { client: qc }, children);
}
```

**Zustand store test** (`src/hooks/__tests__/usePrivacyMode.test.ts`):
```ts
beforeEach(() => { usePrivacyMode.setState({ isPrivate: false }); }); // reset between tests
```

### Do NOT
- Hit real APIs or network in tests — always mock `@/api/client`.
- Use `setTimeout` or `sleep` — use `waitFor()` from `@testing-library/react`.
- Import `describe`/`it`/`expect` explicitly — `globals: true` is set in `vitest.config.ts`.
