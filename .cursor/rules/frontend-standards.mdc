---
description: Apply when working with Streamlit frontend code in the frontend/ directory. Covers caching strategies, session state management, layout patterns, and privacy mode.
globs: ["frontend/**"]
---

# Frontend Standards (Streamlit)

## Caching
-   Use `@st.cache_data` for data fetches and `@st.cache_resource` for connections.
-   Always set `ttl` to avoid stale data (e.g., `@st.cache_data(ttl=300)`).

## Session State
-   Use `st.session_state` for cross-rerun persistence.
-   Initialize with `if key not in st.session_state: st.session_state[key] = default`.

## Configuration
-   All labels, URLs, and thresholds go in `frontend/config.py`. No magic strings in view files.

## Layout
-   Reference existing views in `frontend/views/` for page structure patterns before creating new pages.

## API Calls
-   All backend calls go through helper functions in `frontend/utils.py`. Never call `requests` directly in view files.

## Privacy Mode

The app supports a cross-device privacy toggle that masks all sensitive monetary values.

### Rules
- **Monetary values** (prices, market values, totals, costs) MUST be formatted through `_mask_money(value, fmt)`, never with raw f-strings or `.format()`.
- **Quantities** (share counts, unit amounts) MUST be formatted through `_mask_qty(value, fmt)`.
- **Backend-generated text** that embeds monetary amounts (e.g., advice strings from `_generate_fx_advice`) MUST be rendered through `_render_advice(lines)`, never raw `st.write()`.
- **Exchange rates and other numeric table columns** that could reveal portfolio details MUST check `_is_privacy()` and substitute `PRIVACY_MASK` when active.
- The privacy state is checked via `_is_privacy()` which reads `st.session_state["privacy_mode"]`.
- The mask placeholder is `PRIVACY_MASK` from `frontend/config.py`.

### Existing helpers (defined in `frontend/views/allocation.py` and `frontend/views/dashboard.py`)
- `_mask_money(value, fmt="${:,.2f}")` -- formats or masks a monetary value
- `_mask_qty(value, fmt="{:,.4f}")` -- formats or masks a quantity
- `_render_advice(lines)` -- renders advice strings, regex-masking embedded amounts
- `_is_privacy()` -- returns True when privacy toggle is active

### Checklist for new features
- Every `st.metric()` showing money or quantities: use `_mask_money()` / `_mask_qty()`
- Every `st.dataframe()` column with amounts: use `_mask_money()` per cell
- Every `st.write()` of backend-generated text with numbers: use `_render_advice()`
- Plotly chart `textinfo` and `hovertemplate`: conditionally hide values (see `_render_fx_donut` pattern)
