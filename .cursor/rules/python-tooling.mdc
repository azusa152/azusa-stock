---
description: Apply when working with Python backend code. Covers Python tooling standards including ruff formatter/linter, dependencies management, Makefile usage, and logging practices.
globs:
  - "backend/**/*.py"
alwaysApply: false
---

# Python Tooling Standards

## Python Version
- **Python version:** 3.12+ (match CI in `.github/workflows/ci.yml`).

## Formatter/Linter
- **Formatter/Linter:** Use `ruff` for both formatting and linting. Run `ruff check --fix` and `ruff format` before committing.
- **Import ordering:** stdlib, third-party, local — ruff handles this automatically.

## Makefile Shortcuts
- **Fullstack targets:** `make lint` (backend + frontend), `make test` (backend; frontend added in Phase 4), `make format` (backend). These run the whole project.
- **Granular targets:** `make backend-lint`, `make backend-test`, `make backend-format` for backend only; `make frontend-lint` for frontend only.
- **CI gate:** Use `make ci` to run all linting + all tests — this mirrors what the CI pipeline runs. Always pass before committing.
- **Cleanup:** Use `make clean` to remove `.pytest_cache`, `.ruff_cache`, `dist`, and `node_modules/.cache`.
- Run `make help` to see all available targets.

## Dependencies
- **Dependencies:** Pin versions in `requirements.txt`. When adding a new package, add it with a pinned version.

## Logging
- Use `from logging_config import get_logger` and `logger = get_logger(__name__)` in every backend module.
- Never use `print()` for diagnostic output; always use `logger.info()` / `logger.warning()` / `logger.error()`.
- Log messages in Traditional Chinese (developer-facing, intentionally not translated via i18n).
- User-facing messages (API responses, Telegram notifications) MUST use `t()` for i18n.
- Log levels: DEBUG for tracing, INFO for business events, WARNING for recoverable issues, ERROR for failures.

## i18n (Backend)
- All user-facing API responses MUST use `t()`: `from i18n import t`
- Resolve language at API layer: `lang=get_user_language(session)`
- Locale files: `backend/i18n/locales/{en,ja,zh-CN,zh-TW}.json`
- Default: `zh-TW`. Fallback: requested lang → `zh-TW` → raw key
- **Return machine-readable keys for display labels.** For any field the frontend will render as a display label (e.g. a level, a status, a category name), return an enum key or constant string (e.g. `"low"`, `"moderate"`). Let the frontend handle translation via `t()`. Only use backend `t()` for long-form prose (advice sentences, disclaimers) that cannot easily be keyed.

## Pydantic Schemas
- **Separate Create vs Update schemas.** Every endpoint that mutates a resource must have its own schema: `FooRequest` for creation (required fields) and `UpdateFooRequest` for partial updates (all fields `Optional`). Never reuse a create schema as the update endpoint's request body — required fields will cause 422 errors when the frontend sends partial payloads.
- After adding or changing any schema in `backend/api/schemas.py`, run `make generate-api` to keep the frontend TypeScript types in sync.
