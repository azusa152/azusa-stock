---
description: Apply when working with Python backend code. Covers Python tooling standards including ruff formatter/linter, dependencies management, Makefile usage, and logging practices.
globs:
  - "backend/**/*.py"
alwaysApply: false
---

# Python Tooling Standards

## Python Version
- **Python version:** 3.12+ (match CI in `.github/workflows/ci.yml`).

## Formatter/Linter
- **Formatter/Linter:** Use `ruff` for both formatting and linting. Run `ruff check --fix` and `ruff format` before committing.
- **Import ordering:** stdlib, third-party, local — ruff handles this automatically.

## Makefile Shortcuts
- **Fullstack targets:** `make lint` (backend + frontend), `make test` (backend + frontend), `make format` (backend). These run the whole project.
- **Granular targets:** `make backend-lint`, `make backend-test`, `make backend-format` for backend only; `make frontend-lint`, `make frontend-test`, `make frontend-build`, `make frontend-security` for frontend only.
- **CI gate:** Use `make ci` — it mirrors ALL GitHub CI pipeline jobs. If `make ci` passes locally, the GitHub pipeline will pass too. Always run before committing.
  - Covers: `lint`, `test`, `check-constants`, `check-api-spec`, `check-i18n`, `frontend-build`, `frontend-security`, `backend-security`, `backend-typecheck`
  - Run `make check-ci` to verify `make ci` still covers all pipeline jobs (auto-enforced by CI and pre-commit).
- **Cleanup:** Use `make clean` to remove `.pytest_cache`, `.ruff_cache`, `dist`, and `node_modules/.cache`.
- Run `make help` to see all available targets.

## Dependencies
- **Dependencies:** Use [uv](https://docs.astral.sh/uv/). Edit `backend/pyproject.toml` (direct dependencies under `[project.dependencies]` or `[dependency-groups]`) and run `make lock` to regenerate the pinned `backend/uv.lock`. Never edit `uv.lock` by hand.
- **Dev tools** (e.g. `pip-audit`, `ruff`, `pytest`) belong in `[dependency-groups.dev]` in `pyproject.toml` — never install them ad-hoc inside Makefile targets.
- **Adding a new CI job:** Add the job to `.github/workflows/ci.yml`, add its job ID + corresponding make target to `KNOWN_JOB_MAP` in `scripts/check_ci_completeness.py`, and wire the make target into `make ci`. The `ci-completeness` pre-commit hook and CI job will enforce this. For infrastructure-only jobs (path filtering, meta-checks, merge gates), add the job ID to `SKIP_JOBS` instead of `KNOWN_JOB_MAP` — the `ci-gate` and `ci-completeness` jobs are examples of this. The `CI Gate` job is the sole required status check for merging to `main`; never remove it from `SKIP_JOBS`.

## Test Coverage

- `make backend-test` runs pytest with `pytest-cov` and enforces a coverage threshold. Config lives in `backend/pyproject.toml` under `[tool.coverage.report]`.
- Current floor: `fail_under = 85`. When coverage improves, raise this value and commit the new floor (ratchet approach — thresholds only go up).
- All new code in `application/`, `domain/`, and `api/` should have corresponding tests. Use `# pragma: no cover` sparingly for genuinely untestable branches.
- `relative_files = true` is set in the coverage config — required for CI and py-cov-action badge generation to work correctly.

## Logging
- Use `from logging_config import get_logger` and `logger = get_logger(__name__)` in every backend module.
- Never use `print()` for diagnostic output; always use `logger.info()` / `logger.warning()` / `logger.error()`.
- Log messages in Traditional Chinese (developer-facing, intentionally not translated via i18n).
- User-facing messages (API responses, Telegram notifications) MUST use `t()` for i18n.
- Log levels: DEBUG for tracing, INFO for business events, WARNING for recoverable issues, ERROR for failures.

## i18n (Backend)
- All user-facing API responses MUST use `t()`: `from i18n import t`
- Resolve language at API layer: `lang=get_user_language(session)`
- Locale files: `backend/i18n/locales/{en,ja,zh-CN,zh-TW}.json`
- Default: `zh-TW`. Fallback: requested lang → `zh-TW` → raw key
- **Return machine-readable keys for display labels.** For any field the frontend will render as a display label (e.g. a level, a status, a category name), return an enum key or constant string (e.g. `"low"`, `"moderate"`). Let the frontend handle translation via `t()`. Only use backend `t()` for long-form prose (advice sentences, disclaimers) that cannot easily be keyed.

## Pydantic Schemas
- **Separate Create vs Update schemas.** Every endpoint that mutates a resource must have its own schema: `FooRequest` for creation (required fields) and `UpdateFooRequest` for partial updates (all fields `Optional`). Never reuse a create schema as the update endpoint's request body — required fields will cause 422 errors when the frontend sends partial payloads.
- After adding or changing any schema in `backend/api/schemas.py`, run `make generate-api` to keep the frontend TypeScript types in sync.
