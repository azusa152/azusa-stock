---
description: Backend testing standards with pytest. Apply when writing or modifying tests in backend/tests/ or any test files.
globs:
  - "backend/tests/**"
  - "**/*test*.py"
  - "**/conftest.py"
alwaysApply: false
---

# Backend Testing Standards (pytest)

Every feature MUST ship with tests. Bug fixes MUST include regression tests. No untested code in production.

## Test File Structure

Tests live in `backend/tests/` mirroring the source layout.

## Test Naming

Use descriptive names: `test_<function>_should_<expected_behavior>`

## AAA Pattern

Every test follows **Arrange / Act / Assert**. See `backend/tests/` for canonical examples.

## Fixtures & conftest.py

- `conftest.py` provides: `TestClient`, in-memory SQLite DB, mock yfinance data, mock Telegram sender.
- Use `@pytest.fixture` with appropriate scope (`session` for DB, `function` for per-test isolation).

## Mock External Services

- **yfinance**, **Telegram Bot API**, and any network I/O MUST be mocked. Never hit real APIs in tests.
- Use `unittest.mock.patch` or `pytest-mock` to replace infrastructure adapters.

## Minimum Test Coverage Per Endpoint

| Scenario | Status Code |
|----------|-------------|
| Happy path | 200 / 201 |
| Validation error | 422 |
| Not found | 404 |
| Conflict / duplicate | 409 (where applicable) |

## Webhook Action Coverage

- Every webhook action MUST have at least **one happy-path test** and **one error-path test**.
- The `help` action must be tested to ensure discoverability stays accurate.
